# Route Makefile Analysis

|Project|Author|Start Date|End Date|
|---|---|---|---|
|Routing|A.B.M Tafsirul Islam|1-Apr-2024|1-Apr-2024|

# Route Portion

```
648 # ==============================================================================
649 #  ____   ___  _   _ _____ ___ _   _  ____
650 # |  _ \ / _ \| | | |_   _|_ _| \ | |/ ___|
651 # | |_) | | | | | | | | |  | ||  \| | |  _
652 # |  _ <| |_| | |_| | | |  | || |\  | |_| |
653 # |_| \_\\___/ \___/  |_| |___|_| \_|\____|
654 #
655 .PHONY: route
656 route: $(RESULTS_DIR)/5_route.odb \
657        $(RESULTS_DIR)/5_route.sdc
658 # ==============================================================================
659 
660 
661 # STEP 1: Run global route
662 #-------------------------------------------------------------------------------
663 $(eval $(call do-step,5_1_grt,$(RESULTS_DIR)/4_cts.odb $(FASTROUTE_TCL) $(PRE_GLOBAL_ROUTE),global_route))
664 
665 # STEP 2: Run detailed route
666 #-------------------------------------------------------------------------------
667 ifeq ($(USE_WXL),)
668 $(eval $(call do-step,5_2_route,$(RESULTS_DIR)/5_1_grt.odb,detail_route))
669 else
670 $(eval $(call do-step,5_2_route,$(RESULTS_DIR)/4_cts.odb,detail_route))
671 endif
672 
673 $(eval $(call do-copy,5_route,5_2_route.odb))
674 
675 $(eval $(call do-copy,5_route,4_cts.sdc,,.sdc))
676 
677 .PHONY: do-route
678 do-route:
679   $(UNSET_AND_MAKE) do-5_1_grt do-5_2_route do-5_route do-5_route.sdc
680 
681 $(RESULTS_DIR)/5_route.v:
682   @export OR_DB=5_route ;\
683   $(OPENROAD_CMD) ./scripts/write_verilog.tcl
684 
685 .PHONY: clean_route
686 clean_route:
687   rm -rf output*/ results*.out.dmp layer_*.mps
688   rm -rf *.gdid *.log *.met *.sav *.res.dmp
689   rm -rf $(RESULTS_DIR)/route.guide $(RESULTS_DIR)/output_guide.mod $(RESULTS_DIR)/updated_clks.sdc
690   rm -rf $(RESULTS_DIR)/5_*.odb $(RESULTS_DIR)/5_route.sdc $(RESULTS_DIR)/5_*.def $(RESULTS_DIR)/5_*.v
691   rm -f  $(REPORTS_DIR)/5_*
692   rm -f  $(LOG_DIR)/5_*
693 
694 .PHONY: klayout_tr_rpt
695 klayout_tr_rpt: $(RESULTS_DIR)/5_route.def $(OBJECTS_DIR)/klayout.lyt
696   $(call KLAYOUT_FOUND)
697   $(KLAYOUT_CMD) -rd in_drc="$(REPORTS_DIR)/5_route_drc.rpt" \
698           -rd in_def="$<" \
699           -rd tech_file=$(OBJECTS_DIR)/klayout.lyt \
700           -rm $(UTILS_DIR)/viewDrc.py
701 
702 .PHONY: klayout_guides
703 klayout_guides: $(RESULTS_DIR)/5_route.def $(OBJECTS_DIR)/klayout.lyt
704   $(call KLAYOUT_FOUND)
705   $(KLAYOUT_CMD) -rd in_guide="$(RESULTS_DIR)/route.guide" \
706           -rd in_def="$<" \
707           -rd net_name=$(GUIDE_NET) \
708           -rd tech_file=$(OBJECTS_DIR)/klayout.lyt \
709           -rm $(UTILS_DIR)/viewGuide.py

```

# Analysis

- **Line 663:**
    - Let's break down the `$(eval $(call do-step,5_1_grt,$(RESULTS_DIR)/4_cts.odb $(FASTROUTE_TCL) $(PRE_GLOBAL_ROUTE),global_route))` command step by step:

        1. **`call do-step,5_1_grt,$(RESULTS_DIR)/4_cts.odb $(FASTROUTE_TCL) $(PRE_GLOBAL_ROUTE),global_route`**: Here, the `call` function is used to invoke the `do-step`  with specific arguments. The arguments provided are:
        - `5_1_grt`: This is passed as `$(1)` in the `do-step` , representing the base name of the file.
        - `$(RESULTS_DIR)/4_cts.odb $(FASTROUTE_TCL) $(PRE_GLOBAL_ROUTE)`: This is passed as `$(2)` in the `do-step` , representing dependencies required to build the target. It seems to be a space-separated list of dependencies.
        - `global_route`: This is passed as `$(3)` in the `do-step` , representing the Tcl script step to be executed.

        2. **`$(eval ...)`**: The `eval` function is used to evaluate and execute the resulting string generated by the `call` function. It allows dynamic generation and execution of Makefile code.

        Combining these parts, the command dynamically generates and executes rules specified by the `do-step` for the `5_1_grt` target. The is called with specific parameters to define how the `global_route` stage should be executed for the `5_1_grt` target, including its dependencies and the Tcl script to be run.

        The behavior and actions performed during the `global_route` stage for the `5_1_grt` target are determined by the implementation details within the `do-step`, which includes executing the Tcl script with appropriate parameters and handling output/logging as specified in the definition.

- **Line 668:**
    - Let's break down the command `$(eval $(call do-step,5_2_route,$(RESULTS_DIR)/5_1_grt.odb,detail_route))` step by step:

        1. **`call do-step,5_2_route,$(RESULTS_DIR)/5_1_grt.odb,detail_route`**: The `call` function invokes the `do-step`  with specific arguments. The arguments provided are:
        - `5_2_route`: This is passed as `$(1)` in the `do-step` , representing the base name of the file.
        - `$(RESULTS_DIR)/5_1_grt.odb`: This is passed as `$(2)` in the `do-step` , representing dependencies required to build the target.
        - `detail_route`: This is passed as `$(3)` in the `do-step` , representing the Tcl script step to be executed.

        2. **`$(eval ...)`**: The `eval` function is used to evaluate and execute the resulting string generated by the `call` function. It allows dynamic generation and execution of Makefile code.

            Combining these parts, the command dynamically generates and executes rules specified by the `do-step` for the `5_2_route target` with specific parameters to define how the `detail_route ` stage should be executed for the `5_2_route` target, including its dependencies and the Tcl script to be run.

            

- **Line 670:**
    - Let's break down the command `$(eval $(call do-step,5_2_route,$(RESULTS_DIR)/4_cts.odb,detail_route))` step by step:

        1. **`call do-step,5_2_route,$(RESULTS_DIR)/4_cts.odb,detail_route`**: The `call` function invokes the `do-step` with specific arguments. The arguments provided are:
        - `5_2_route`: This is passed as `$(1)` in the `do-step`, representing the base name of the file.
        - `$(RESULTS_DIR)/4_cts.odb`: This is passed as `$(2)` in the `do-step`, representing dependencies required to build the target.
        - `detail_route`: This is passed as `$(3)` in the `do-step`, representing the Tcl script step to be executed.

        2. **`$(eval ...)`**: The `eval` function is used to evaluate and execute the resulting string generated by the `call` function. It allows dynamic generation and execution of Makefile code.

            Combining these parts, the command dynamically generates and executes rules specified by the `do-step` for the `5_2_route ` target  with specific parameters to define how the `detail_route` stage should be executed for the `5_2_route` target, including its dependencies and the Tcl script to be run.

- **Line 673:**
    - Let's break down the command `$(eval $(call do-copy,5_route,5_2_route.odb))` step by step:

        1. **`call do-copy,5_route,5_2_route.odb`**: The `call` function is used to invoke the `do-copy` with specific arguments. The arguments provided are:
        - `5_route`: This is passed as `$(1)` in the `do-copy`, representing the stem (base name of the file) of the target file name.
        - `5_2_route.odb`: This is passed as `$(2)` in the `do-copy`, representing the basename of the file to be copied.

        2. **`$(eval ...)`**: The `eval` function is used to evaluate and execute the resulting string generated by the `call` function. It allows dynamic generation and execution of Makefile code.

        Combining these parts, the command expands to create and execute the rules specified by the `do-copy` for copying the file `5_2_route.odb` to `5_route.odb` within the `$(RESULTS_DIR)` directory.

        Let's break down how this expansion happens based on the `do-copy` provided:

        - The target file (`$(RESULTS_DIR)/5_route.odb`) is defined based on the stem provided (`5_route`) and the default extension (`.odb`).
        - The dependency for this target is the file `$(RESULTS_DIR)/5_2_route.odb`.
        - The `do-5_route` phony target is created to trigger the copy operation.
        - The copy operation is performed using the `cp` command, copying `$(RESULTS_DIR)/5_2_route.odb` to `$(RESULTS_DIR)/5_route.odb`.

- **Line 675:** 
    - Let's break down the command `$(eval $(call do-copy,5_route,4_cts.sdc,,.sdc))` step by step:

        1. **`call do-copy,5_route,4_cts.sdc,,.sdc`**: The `call` function is used to invoke the `do-copy` with specific arguments. The arguments provided are:
        - `5_route`: This is passed as `$(1)` in the `do-copy`, representing the stem of the target file name.
        - `4_cts.sdc`: This is passed as `$(2)` in the `do-copy`, representing the basename of the file to be copied.
        - `""`: This is passed as `$(3)` in the `do-copy`, representing further dependencies. In this case, there are no additional dependencies specified.
        - `.sdc`: This is passed as `$(4)` in the `do-copy`, representing the target extension.

        2. **`$(eval ...)`**: The `eval` function is used to evaluate and execute the resulting string generated by the `call` function. It allows dynamic generation and execution of Makefile code.

            Combining these parts, the command dynamically generates and executes rules specified by the `do-copy` for copying the file `4_cts.sdc` to `5_route.sdc` within the specified directory (defaulting to `$(RESULTS_DIR)`). The file extension `.sdc` is explicitly specified for the target.

            The `do-copy` is responsible for defining the rules for this copy operation, including specifying the target file, dependencies, and executing the copy command using the `cp` command or similar. The actual behavior is determined by the implementation details within the `do-copy`.
    
- **Line 679:**
    - Let's break down the line `$(UNSET_AND_MAKE) do-5_1_grt do-5_2_route do-5_route do-5_route.sdc` with the provided `UNSET_AND_MAKE` definition and other related information:

        1. **`UNSET_AND_MAKE` Definition**:
        
            ```
            UNSET_AND_MAKE = @bash -c 'for var in $(UNSET_VARIABLES_NAMES); do unset $$var; done; echo $(MAKE) DESIGN_CONFIG=$(DESIGN_CONFIG) $$@; $(MAKE) DESIGN_CONFIG=$(DESIGN_CONFIG) $$@'
            ```

            - This definition sets up a command that unsets specified variables (`$(UNSET_VARIABLES_NAMES)`) and then calls `make` with specific arguments (`DESIGN_CONFIG=$(DESIGN_CONFIG) $$@`) to perform the build tasks.

        2. **Other Information**:
        
            ```
            DESIGN_CONFIG=./designs/asap7/riscv32i/config.mk
            ```

        - This line sets the `DESIGN_CONFIG` variable to `./designs/asap7/riscv32i/config.mk`.

        3. **Explanation**:
        When we use `$(UNSET_AND_MAKE) do-5_1_grt do-5_2_route do-5_route do-5_route.sdc`, here's what happens step by step:

            - The `UNSET_AND_MAKE` command is executed, which unsets specific variables defined in `UNSET_VARIABLES_NAMES`.
            - It then calls `make` with arguments `DESIGN_CONFIG=$(DESIGN_CONFIG) do-5_1_grt`, `DESIGN_CONFIG=$(DESIGN_CONFIG) do-5_2_route`, `DESIGN_CONFIG=$(DESIGN_CONFIG) do-5_route`, `DESIGN_CONFIG=$(DESIGN_CONFIG) do-5_route.sdc`, respectively.

                The `DESIGN_CONFIG=$(DESIGN_CONFIG)` part ensures that the `DESIGN_CONFIG` variable is passed correctly to the `make` command for each target.
 